<!-- blog/templates/blog/post_detail.html -->
{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ post.title }} — TravelBlog{% endblock %}

{% block meta_description %}
    <meta name="description" content="{{ post.meta_description|default:post.content_markdown|truncatewords:30 }}"/>
{% endblock %}

{% block extra_css %}
    <!-- Подключаем Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
{% endblock %}

{% block breadcrumbs %}
    {% if breadcrumbs %}
        <nav class="text-sm mb-6 text-text-body/70">
            {% for crumb in breadcrumbs %}
                {% if crumb.1 %}
                    <a href="{{ crumb.1 }}" class="hover:text-primary transition">{{ crumb.0 }}</a>
                {% else %}
                    <span class="font-medium text-secondary">{{ crumb.0 }}</span>
                {% endif %}
                {% if not forloop.last %} / {% endif %}
            {% endfor %}
        </nav>
    {% endif %}
{% endblock %}

{% block content %}
    <!-- Post Header -->
    <header class="mb-8 max-w-4xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold mb-3 text-secondary">{{ post.title }}</h1>
        <div class="flex flex-wrap items-center text-sm text-text-body/70 gap-3 mb-4">
            <span>Автор: {{ post.author.get_full_name|default:post.author.username }}</span>
            <span>•</span>
            <time datetime="{{ post.published_at|date:'Y-m-d' }}">{{ post.published_at|date:"d E Y" }}</time>
            <span>•</span>
            <span>Просмотров: {{ post.views_count| intcomma }}</span>
            <span>•</span>
            <span>Рейтинг:
        <span class="text-primary font-medium">★{{ post.average_rating|default:"—" }}</span>
        ({{ post.rating_count }})
      </span>
        </div>
        <div class="flex flex-wrap gap-2">
            {% for tag in post.tags.all %}
                <a href="{{ tag.get_absolute_url }}"
                   class="px-2 py-1 bg-tertiary/20 text-primary text-xs rounded hover:bg-tertiary/40 transition">
                    {{ tag.name }}
                </a>
            {% endfor %}
        </div>
    </header>

    <!-- Cover Image -->
    {% if post.cover_image %}
        <figure class="mb-8 rounded-lg overflow-hidden border border-tertiary max-w-4xl mx-auto">
            <img src="{{ post.cover_image.url }}" alt="{{ post.title }}" class="w-full h-auto"/>
            <figcaption class="mt-2 text-center text-text-body/70">{{ post.meta_title }}</figcaption>
        </figure>
    {% endif %}

    <!-- Content -->
    <article class="prose prose-lg mb-10 max-w-4xl mx-auto">
        {{ content_markdown_safe }}
    </article>

    <!-- Gallery -->
    {% if post.gallery.exists %}
        <!-- HTML-разметка для Swiper -->
        <div class="relative w-full max-w-full mx-auto my-6 swiper-container">
            <div class="swiper swiper-gallery">
                <div class="swiper-wrapper mb-7">
                    {% for img in post.gallery.all %}
                        <div class="swiper-slide flex flex-col items-center justify-center rounded-lg border border-tertiary shadow-sm overflow-hidden">
                            <div class="relative w-full h-64 md:h-72 lg:h-80">
                                <img
                                        src="{{ img.image.url }}"
                                        class="w-full h-full object-cover"
                                        loading="lazy"
                                        alt="{{ img.caption }}"
                                />
                                <div class="swiper-lazy-preloader swiper-lazy-preloader-white"></div>
                            </div>
                            {% if img.caption %}
                                <p class="mt-2 text-sm text-center text-gray-600">{{ img.caption }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <!-- Стрелки навигации -->
                <div class="swiper-button-next !text-white !bg-black/50 !w-10 !h-10 !rounded-full after:!text-xs"></div>
                <div class="swiper-button-prev !text-white !bg-black/50 !w-10 !h-10 !rounded-full after:!text-xs"></div>

                <!-- Пагинация (точки) -->
                <div class="swiper-pagination !bottom-0 !pb-2"></div>
            </div>
        </div>
    {% endif %}


    <!-- Rating -->
    <section class="bg-white p-6 rounded-lg shadow border border-tertiary max-w-2xl mx-auto">
        <h3 class="text-xl font-semibold mb-4 text-secondary">Оцените эту статью</h3>
        <div class="flex items-center space-x-2">
            {% for i in "12345" %}
                {#        {% if forloop.counter <= post.average_rating|default:0|floatformat:0|int %}#}
                {% if forloop.counter <= post.average_rating|default:0|floatformat:0 %}
                    <span class="text-primary">★</span>
                {% else %}
                    <span class="text-tertiary">★</span>
                {% endif %}
            {% endfor %}
            <span class="ml-2 text-text-body/80">
        {{ post.average_rating|default:"—" }} из 5 ({{ post.rating_count }} голосов)
      </span>
        </div>
        <p class="text-sm text-text-body/60 mt-2">Оценка учитывается по IP-адресу (один раз на пост).</p>
    </section>
{% endblock %}

{% block extra_js %}
    <!-- Подключаем Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Инициализация Swiper -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const swiper = new Swiper('.swiper-gallery', {
                loop: true,
                slidesPerView: 1,
                spaceBetween: 16,
                lazy: true,
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                },
                breakpoints: {
                    640: {slidesPerView: 2},
                    768: {slidesPerView: 3},
                    1024: {slidesPerView: 3},
                },
                autoplay: {
                    delay: 5000,
                    disableOnInteraction: false,
                },
                speed: 800,
            });
        });
    </script>

{% endblock %}